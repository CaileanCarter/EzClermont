---
title: 'this is manually overridden'
date: "`r format(Sys.time(), '%d %B, %Y')`"
toc: false
fontsize: 10pt
papersize: a4 
geometry: margin=2cm
#     - \usepackage{setspace}
#     - \doublespacing
#     - \usepackage{lineno}
#     - \linenumbers
header-includes:
  - \usepackage{float}
  - \title{\fontseries{m}\selectfont Easily phylotyping \textit{E. coli} via the EzClermont web app and command-line tool.}
  - \author{\small Nicholas R. Waters,$^{1,2}$ Florence Abram,$^{1}$ Fiona Brennan,$^{1,3}$ Ashleigh Holmes,$^{4}$ and Leighton Pritchard$^{2,5\ast}$ \newline \newline \small{\textit {$^{1}$Department of Microbiology, School of Natural Sciences, National University of Ireland, Galway, Ireland}} \newline \small{\textit {$^{2,5}$Information and Computational Sciences, James Hutton Institute, Invergowrie, Dundee DD2 5DA, Scotland}} \newline \small{\textit {$^{3}$Soil and Environmental Microbiology, Environmental Research Centre, Teagasc, Johnstown Castle, Wexford, Ireland}}\newline \small{\textit {$^{4}$Cell and Molecular Sciences, James Hutton Institute, Invergowrie, Dundee DD2 5DA, Scotland}}\newline  \small{\textit {$^{5}$Strathclyde Institute of Pharmacy and Biomedical Sciences, University of Strathclyde, Glasgow, G1 1XQ, Scotland}}\newline \footnotesize{$^\ast$To whom correspondence should be addressed$:$ leighton.pritchard@strath.ac.uk \newline \newline}}
output:
  bookdown::pdf_document2: 
     fig_caption: true
     keep_tex: true
editor_options:
  chunk_output_type: console
#bibliography: /Users/nick/GitHub/soil-persistent-ecoli/soil_persistent_ecoli.bib
abstract: The Clermont PCR method for phylotyping *Escherichia coli* remains a useful classification scheme even though genome sequencing is now routine, and higher-resolution sequence typing schemes are now available. Relating preset-day whole-genome *E. coli* classifications to legacy phylotyping is essential for harmonising the historical literature and understanding of this important organism. We therefore present EzClermont - a novel *in silico* Clermont PCR phylotyping tool to enable ready application of this phylotyping scheme to whole genome assemblies. We evaluate this tool against phylogenomic classifications, and an alternative software implementation of Clermont typing. EzClermont is available as a web app at  <http://www.ezclermont.org>, and as a command-line tool at <https://nickp60.github.io/EzClermont/>.  

---
```{r, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)
#knitr::opts_chunk$set(fig.pos = 'H')
library(tidyverse)
library(kableExtra)
```
## Introduction {-}
*Escherichia coli* is one of the the most widely-studied and best understood organisms in biology. Even before widespread whole-genome sequencing it was known that the *E. coli* species group is very diverse [@lukjancenko_comparison_2010; @selander_genetic_1987], and several methods were developed to differentiate the various  *E. coli* lineages.
<!-- %In addition to being a member of the human gut microbiome, *E. coli* are found in soil, water, and livestock. The majority of lineages are harmless, but some can cause serious illness.  Thus, detecting and identifying the different lineages has remainedva valuable goal both for understanding the pathalogy as well as for detecting problematic strains. -->
In 1987, Selandar  and colleagues first used electrophoretic analysis of a 35 enzyme digest to classify the *E. coli* Reference Collection (ECOR) into 6 groups (A-F) [@selander_genetic_1987].  Subsequently, Clermont & colleagues published a triplex PCR method for phylotyping, able to differentiate four of these groups - A, B1, B2 and D [-@clermont_rapid_2000].  In 2013, Clermont and colleagues updated this scheme, adding a fourth set of primers to detect groups E and F; additional primers were also proposed to differentiate the cryptic clades [@clermont_clermont_2013]. This method was again recently extended to include primers that differentiate the newly-identified G phylogroup [@clermont_characterization_2019]. The Claremont quadruplex primers have been widely adopted for laboratory-based classification as the method is reliable, easy to interpret, and correctly classifies about 95\% of *E. coli* strains.

Other typing schemes developed to classify *E. coli* strains include: the Achtman 7 gene Multi Locus Sequence Typing (MLST)[@achtman_multilocus_2012;@alikhan_genomic_2018]; Michigan EcMLST [@qi_ecmlst_2004]; whole-genome MLST (<http://www.applied-maths.com/applications/wgmlst>); core-genome MLST [@debeen_core_2015]; two-locus MLST[@weissman_highresolution_2012]; and ribosomal MLST [@jolley_ribosomal_2012]. All of these sequencing-based methods classify *E. coli* with greater accuracy and to higher resolution than Clermont phylotyping. Any practical choice of approach involves trade-offs of cost and complexity against the precision offered by the methodology. The @clermont_clermont_2013 phylotyping scheme remains a popular tool for *E. coli* classification as it can be performed rapidly and inexpensively in a laboratory. In addition, this classification scheme remains useful to make comparisons of newly-sequenced isolates against historical literature, which contains many references to strains classified only by the Clermont scheme.

EzClermont was developed to bridge the gap between the traditional quadruplex primer approach to phylotyping and whole-genome seqenuce data. It provides a simple *in silico* analogue of the Clermont phylotyping approach, applied to genome assemblies. We  implemented EzClermont as both a web application for public use, and as a command-line program for local installation. A similar tool called ClermonTyping was recently published, with similar goals and functionality [@beghain_clermontyping_2018].  Here, we describe our implementation of the Clermont classification scheme in EzClermont, assess its ability to correctly assign Clermont type, relative to *E. coli* whole-phylogeny, and compare its performance to the ClermonTyping program.

## Methods {-}
### *In silico* PCR {-}

To emulate PCR *in silico*, EzClermont uses regular expressions (regexes) that represent the Clermont primer sequences to locate their potential binding sites on a sequenced genome. The sequence regions lying between these sites are taken to be the predicted amplicons, and can be evaluated for sequence composition, or presence/absence to determine Clermont phylotype.

In practice, Clermont primer sequences do not always exactly match their productive binding sites, so primer-binding sequence variability must be captured in the corresponding regexes. To represent this variability, we selected 1395 *E. coli* genomes from EnteroBase[**REF**] (accessed April, 2019), filtering on genome metadata quality and source [**MORE (BUT BRIEF) DETAIL/PRECISION NEEDED - PUT DETAILED METHOD IN SUPPLEMENTARy IF NECESSARY**]. The theoretical amplicons of each of the quadruplex, E-specific, C-specific, G-specific, and E/C control primer sets were identified and aligned [**PUT DETAIL - RECIP. BLAST, MAFFT ETC. IN SUPPLEMENTARY**] to identify variations in the canonical primer regions. These were used to establish the regular expressions used to search for primer binding sites in whole genomes [**INSERT A TABLE WITH THESE REGEX SEQUENCES**]. Sequence differences in the last five 5` bases of the reverse primer of each set were not included, as these variations can be used to differentiate alleles [@stadhouders_effect_2010] [**I AM NOT YET CLEAR WHAT THEY WERE NOT INCLUDED/INCORPORATED IN - DO THE PRIMER REGEXES STOP SHORT, BY 5bp?**].

### Validation Dataset and Phylogeny Estimation {-}

The accuracy of EzClermont classification was assessed against a set of 125 *E. coli* isolates having both experimentally-determined Clermont phylotypes and available whole-genome sequencing data [**REFER TO SUPP INFO TABLE HERE**]. This dataset was created from the strains described in @sims_wholegenome_2011, @clermont_guide_2015, with the addition of group G isolates from @clermont_characterization_2019 for which comparable data was available. We determined that sequences from BioProject PRJNA321606 were of insufficient quality for analysis (in line with the conclusions in @patel_draft_2018), therefore this work reports analysis using ECOR sequences from BioProject PRJNA230969. 

We used Parsnp [@treangen_harvest_2014] to obtain a core genome alignment for the 125 strains, similarly to @clermont_characterization_2019 [**DESCRIBE THE DETAIL IN SUPPLEMENTARY**]. PhyML [@guindon_new_2010] was used to estimate the phylogeny of these strains using this nucleotide alignment as input and the HKY85 substitution model, obtaining approximate Bayes bootstrapped branch support [**DETAILS IN SUPPLEMENTARY**]. The resulting tree was visualised with ggtree [@yu_ggtree_2017], and branches were rotated so that the cryptic *Escherichia* assemblies initiate the tree [**REF FIGURE**].

### *In silico* Clermont classification {-}

Both EzClermont (version 0.6.2) and ClermonTyping (version 1.4.1) were run with default parameters on the 125 strains in the validation dataset.

### Confirmation of sequenced isolate Clermont type {-}

Where both *in silico* phylotyping methods predicted a Clermont phylogroup different to that reported for a sequenced strain in the validation set, the short read data corresponding to that assembly was downloaded from NCBI [**LIST THESE IN A SUPPLEMENTARY TABLE**]. Blobtools [@laetsch_blobtools_2017] was run on each downloaded read set to determine and visualize any potential contamination, and a reassembly of each set was performed with SKESA [@souvorov_skesa_2018], and re-assessed with the *in silico* phylotypers.

### Implementation {-}
 
EzClermont is an open-source Python package distributed under the MIT License, available *via* PyPI, conda, and GitHub [**INCLUDE URIS HERE**. The package comprises a command-line tool for batch execution, and a Flask-based webapp.The webapp is hosted as a live service at <http://ezclermont.org>, and a Docker container is available [**AT WHAT URI?**] for local deployment.

### Performance {-}

[**NEEDS PERFORMANCE METHOD DESCRIPTION HERE: COMPUTING SPECS, NUMBER OF RUNS, MEASURING "WALL TIME"**]


## Results {-}

Clermont types reported in the literature are not guaranteed always to correspond to phylogenetic lineage for *E. coli*; *in silico* predictions of phylotype may agree with reported type, lineage, both, or neither. We first therefore established the correspondence between lineage and Clermont type for each isolate in the 125-member validation set and visualised this in Figure \@ref(fig:tree-ez). We found that for seven isolates the lineage was not consistent with the recorded Clermont type [**TABLE**]. In these cases we considered that the phylogenetic lineage was more reliable and took precedence over literature-reported Clermont type, for validating the *in silico* methods.

Figure \@ref(fig:tree-ez) also summarises the resuls of applying both EzClermont and ClermonTyping to the validation dataset. For 123 of 125 isolates, the *in silico* method predictions were consistent with the dominant Clermont type of the phylogenetic lineage. The two mismatched isolates ECOR44 and ECOR49 are, by lineage and literature report, phylogroup D but were mistyped by both EzClermont and ClermonTyping as phylogroups G or E. We examined the source assembly for the ECOR49 isolate and found by reciprocal BLAST search that the canonical arpA fragment that should be present in phylogroup D could not be identified. This would be sufficient to cause misclassification, and suggested that the assembly used for validation might not be complete. We confirmed this by also analysing the alternative ECOR49 assembly GCA_002190975.1; this assembly contains the arpA fragment and both tools assigned this genome correctly to phylogroup D. [**A FIGURE SHOWING ALIGNMENT OF THIS REGION OF THE TWO ECOR49 ASSEMBLIES WOULD BE USEFUL IN SUPP INFO**]

```{r tree-ez, fig.cap="Cladogram of whole-genome phylogenety for members of the ECOR collection and phylogroup G isolates from Clermont et al. 2019. Clades are background-coloured by dominant phylogroup. The heatmap surrounding the tree shows phylogroups determined from: literature (inner ring), ClermonTyping, and EzClermont (outer ring). The literature phylogroup was not supported by *in silico* analysis for seven strains. Both EzClermont and ClermonTyping agree with the phylogenetic lineage in all but two cases: ECOR44 and ECOR49.", out.width="110%" }
knitr::include_graphics(path =  "../analysis/cladogram.png")
```

The ECOR44 isolate was mistyped by ClermonTyping as phylogroup E, and by EzClermont as phylogroup G. This was suggestive of a false negative result *in silico* for the arpA primer set. Closer inspection of the region indicated that the arpA fragment was not correctly identified due to a G->A substitution at base 17 of the reverse primer binding site. This mutation occurs in the final 5 bases of the reverse primer, and so was not incorporated during the training process for the primer regular expressions; a similar [**SIMILAR, OR THE SAME? IF SIMILAR A TABLE OF VARIANTS IN SUPP INFO, MAYBE?**] mutation was seen in a further eight of the 1395 training isolates.

```{r simstab}
restab <- structure(list(Strain = c("SMS-3-5", "APEC01", "ECOR07", "ECOR72", 
"ECOR71", "ECOR43", "ECOR44", "ECOR49", "ECOR23"), Accession = c("GCA_000019645.1", 
"GCA_003028815.1", "GCA_003334305.1", "GCA_003334425.1", "GCA_003333385.1", 
"GCA_003333775.1", "GCA_003333765.1", "GCA_003333685.1", "GCA_003334095.1"
), Reported = c("D", "B2", "A", "B1", "B1", "A", "D", "D", "A"
), Phylogeny = c("F", "A", "B1", "B1", "C", "E", "D", "D*", "B2"
), ClermonTyping = c("F", "A", "B1", "C", "C", "E", "E", "G*", 
"B2"), EzClermont = c("F", "A", "B1", "C", "C", "E", "G", "G*", 
"B2"), Note = c("", 
"", "", "", "", "", "ArpA1_r G17A", 
"", "")), row.names = c(NA, -9L), class = "data.frame")
knitr::kable(longtable=FALSE, booktabs=TRUE,
  #format = "markdown",
  escape = T, col.names = c( "Strain", "Accession",  "Reported",  "Phylogeny", " ClermonTyping", "EzClermont", "Note")  , 
  caption="Isolates with inconsistent phylogroup predictions. EzClermont and ClermonTyping were run on a set of strains with reported phylotypes. A core SNP tree was constructed, allowing comparison between predicted and reported phylotypes, and the estimated phylogeny. Both tools mistype ECOR49 types as phylogroup G due to a potentially contaminated assembly (*); ECOR49 from assembly GCA_002190975.1 is correctly typed by both tools as phylogroup D.",
  restab %>% arrange(Strain)
) %>% kable_styling(latex_options = "striped")
```

We ran our analyses on the 125 member validation set [**X**] times with both EzClermont and ClermonType [**TABLE OF AVERAGE/RANGE OF TIME TAKEN**]. The mean execution time was [**X**] for EzClermont and [**X**] with ClermonTyping, indicating that there is [**NO COMPELLING EFFICIENCY DIFFERENCE BETWEEN THE TWO IMPLEMENTATIONS?**]


## Discussion {-}

EzClermont was built to bridge the gap between established laboratory and whole-genome sequencing methods of classifying *E. coli*. Both EzClermont and ClermonTyping correctly classified 123 of the 125 isolates in our validation set, indicating that they each perform with approximately 98% true positive rate (TPR). Furthermore, a much broader application of EzClermont by @zhou_user_2019 to representative *E. coli* strains in EnteroBase was found to be strongly in agreement with both higher-resolution sequence typing and with ClermonTyping. Although there is [**NO COMPELLING EFFICIENCY DIFFERENCE BETWEEN THE METHODS?**], EzClermont identifies only that isolates are classified as "cryptic", where ClermonTyping distinguishes between cryptic lineages.

Both tools mistyped the same pair of isolates from the validation set. Incomplete assemblies and misassembled genomes in particular are always likely to give erroneous results with genome sequence-based methods. Input genome quality is therefore critical for accurate classification. The arpA fragment appears to be particularly problematic, and @beghain_clermontyping_2018  noted the difficulty in typing with this region, which has likely been horizontally transfered to some phylogroup D isolates.

However, the disagreement observed in this study between phylogenetic lineage and literature-reported phylotype for seven isolates reinforces that laboratory assays also share potential for error, and that these errors may be propagated in literature and metadata. Our comparison of sequencing efforts for the same isolates in two BioProjects implies that, at least in these two collections, the phylogenetic identities of 12 of the 72 strains were not certain (Supplementary Figure \@ref(fig:bioproject-comparison)). Such issues may lead to groups referring to distinct strains by the same name. We found that application of the *in silico* tools was able to correct misassigned phylotype for seven isolates.

EzClermont is implemented as an aplication and as a Python package, and works with STDIN/STOUT for developers to integrate into unix pipelines. It is also presented as a web appplication with an intuitive interface for simple queries. We hope that the incorporation of EzClermont into EnteroBase [@zhou_user_2019], and the utility of applying the local program to large batches of genomes, mean that it will be of continued use to the scientific community.


## Supplementary Figures {-}
\renewcommand\thefigure{S\arabic{figure}}    
\setcounter{figure}{0}  


```{r bioproject-comparison, fig.cap="A core-genome alignment of the assemblies from both ECOR collection sequencing projects was created with Parsnp.  The tip shapes indicate the sequencing project. (A) shows the core genome phylogeny, and (B) shows the same but with equal branch lengths to easier visualize closely-related strains. Yellow tips indicate strains for which the two BioProject's assemblies contradict.", out.width="110%" }
knitr::include_graphics(path =  "../analysis/bioproject_comparison.png")
```


```{r tree-ez-phy, fig.cap="Maximum likelihood tree of core genome alignment showing the relationship of the isolates to their literature-reported and predicted phylotypes.  The cryptic clade isolates were omitted for clarity, and the tree was rerooted at the point where they diverged.", out.width="110%" }
knitr::include_graphics(path =  "../analysis/tree.png")
```


## References {-}





